name: Database Backup

on:
  # schedule:
  #   # Corre cada 12 horas (00:00 y 12:00 UTC)
  #   - cron: '0 0,12 * * *'
  workflow_dispatch: # Solo manual - evita errores sin secrets configurados

jobs:
  backup:
    name: Backup Database
    runs-on: ubuntu-latest
    
    steps:
      - name: Create backup timestamp
        id: timestamp
        run: echo "date=$(date +'%Y%m%d_%H%M%S')" >> $GITHUB_OUTPUT
      
      - name: Download database from Render
        env:
          ADMIN_USERNAME: ${{ secrets.ADMIN_USERNAME }}
          ADMIN_PASSWORD: ${{ secrets.ADMIN_PASSWORD }}
          BACKEND_URL: ${{ secrets.BACKEND_URL }}
        run: |
          # Crear directorio para backup
          mkdir -p backups
          
          echo "ðŸ” Logging in to get admin token..."
          
          # Login to get token
          TOKEN=$(curl -s -X POST \
            -H "Content-Type: application/x-www-form-urlencoded" \
            -d "username=$ADMIN_USERNAME&password=$ADMIN_PASSWORD" \
            "$BACKEND_URL/api/login" | jq -r '.access_token')
          
          if [ -z "$TOKEN" ] || [ "$TOKEN" == "null" ]; then
            echo "âŒ Error: Failed to login"
            exit 1
          fi
          
          echo "âœ… Login successful"
          echo "ðŸ” Iniciando backup automÃ¡tico..."
          
          # Paso 1: Crear backup en el servidor
          echo "ðŸ“¦ Creando backup en servidor..."
          BACKUP_RESPONSE=$(curl -s -X POST \
            -H "Authorization: Bearer $TOKEN" \
            "$BACKEND_URL/api/admin/backup-now")
          
          echo "Response: $BACKUP_RESPONSE"
          
          # Extraer filename del response JSON
          BACKUP_FILENAME=$(echo $BACKUP_RESPONSE | grep -o '"filename":"[^"]*"' | cut -d'"' -f4)
          
          if [ -z "$BACKUP_FILENAME" ]; then
            echo "âŒ Error: No se pudo crear backup"
            echo "Failed to create backup at $(date)" > backups/backup_failed.log
            exit 0
          fi
          
          echo "âœ… Backup creado: $BACKUP_FILENAME"
          
          # Paso 2: Descargar el backup
          echo "â¬‡ï¸ Descargando backup..."
          curl -L -H "Authorization: Bearer $TOKEN" \
               -o "backups/$BACKUP_FILENAME" \
               "$BACKEND_URL/api/admin/backups/$BACKUP_FILENAME"
          
          # Verificar que el archivo existe y tiene contenido
          if [ -f "backups/$BACKUP_FILENAME" ] && [ -s "backups/$BACKUP_FILENAME" ]; then
            echo "âœ… Backup descargado exitosamente"
            ls -lh backups/
          else
            echo "âš ï¸ Backup fallÃ³ o estÃ¡ vacÃ­o"
            echo "Backup failed at $(date)" > backups/backup_failed.log
          fi
      
      - name: Upload backup to GitHub Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: database-backup-${{ steps.timestamp.outputs.date }}
          path: backups/
          retention-days: 90
          compression-level: 9
      
      - name: Backup summary
        run: |
          echo "## ðŸ“¦ Database Backup" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp:** ${{ steps.timestamp.outputs.date }}" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** âœ… Completed" >> $GITHUB_STEP_SUMMARY
          echo "**Retention:** 90 days in GitHub Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Files backed up:" >> $GITHUB_STEP_SUMMARY
          ls -lh backups/ >> $GITHUB_STEP_SUMMARY || echo "No files found"
