#!/bin/bash
set -euo pipefail

# === Enhanced Deployment Script ===
# Rebuild, test, deploy, and backup

REPO_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
BACKUP_DIR="$REPO_DIR/backups"
LOG_FILE="$REPO_DIR/deploy_$(date +%Y%m%d_%H%M%S).log"

ts() { date +"%H:%M:%S"; }
log() { echo "[$(ts)] $*" | tee -a "$LOG_FILE"; }

log "=== CHORIZAURIO DEPLOYMENT ==="

# 1. Backup DB
log "1. Backing up database..."
mkdir -p "$BACKUP_DIR"
docker-compose -f "$REPO_DIR/docker-compose.yml" exec -T backend cp /data/ventas.db /tmp/ventas.db.bak 2>/dev/null || true
docker cp chorizaurio-backend:/tmp/ventas.db.bak "$BACKUP_DIR/ventas.db.$(date +%Y%m%d_%H%M%S).bak" 2>/dev/null || log "   (DB backup skipped - container may not be running)"

# 2. Build images
log "2. Building Docker images..."
cd "$REPO_DIR"
docker-compose build backend frontend 2>&1 | tee -a "$LOG_FILE" || log "   (Build warnings)"

# 3. Start services
log "3. Starting services..."
docker-compose up -d backend frontend
sleep 3

# 4. Wait for services to be ready
log "4. Waiting for services to be ready..."
for i in {1..30}; do
  if curl -s http://localhost:8000/docs >/dev/null 2>&1; then
    log "   âœ“ Backend ready"
    break
  fi
  sleep 1
done

# 5. Run smoke tests
log "5. Running smoke tests..."
if API_URL=http://localhost:8000 USERNAME=testui PASSWORD=test1234 bash smoke.sh 2>&1 | tee -a "$LOG_FILE"; then
    log "   âœ“ Basic smoke tests passed"
else
    log "   âœ— Smoke tests failed"
    exit 1
fi

# 6. Run advanced smoke tests
log "6. Running advanced smoke tests..."
if API_URL=http://localhost:8000 USERNAME=testui PASSWORD=test1234 bash smoke-advanced.sh 2>&1 | tee -a "$LOG_FILE"; then
    log "   âœ“ Advanced smoke tests passed"
else
    log "   âœ— Advanced smoke tests failed"
    exit 1
fi

# 7. Health checks
log "7. Running health checks..."
backend_health=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8000/docs)
if [[ "$backend_health" == "200" ]]; then
    log "   âœ“ Backend API healthy (status: $backend_health)"
else
    log "   âœ— Backend API unhealthy ($backend_health)"
    exit 1
fi

# 8. Summary
log "=== DEPLOYMENT COMPLETE ==="
log "ğŸ“‹ Logs: $LOG_FILE"
log "ğŸ’¾ DB Backup: $BACKUP_DIR"
log "ğŸŒ Frontend: http://localhost:5173"
log "ğŸ“š API Docs: http://localhost:8000/docs"

echo "ğŸ”„ Haciendo pull desde GitHub..."
git pull

echo "ğŸ›‘ Deteniendo contenedores anteriores..."
docker compose down || true

# âœ… Verificar existencia de .env para el backend
if [ ! -f .env ]; then
  echo "âŒ Falta archivo .env para el backend (./.env)"
  exit 1
fi

# âœ… Verificar existencia de archivo .env para el frontend
if [ ! -f frontend/.env ]; then
  echo "âŒ Falta archivo frontend/.env"
  exit 1
else
  echo "âœ… Archivo .env del frontend ya existe. Verificalo si da error."
fi

# âœ… Validar VITE_API_URL
if ! grep -q "VITE_API_URL=http" frontend/.env; then
  echo "âš ï¸ VITE_API_URL no estÃ¡ definido correctamente en frontend/.env"
  exit 1
fi

# âœ… Base de datos
echo "ğŸ—ƒï¸ Verificando base de datos..."
if [ ! -f ventas.db ]; then
    echo "âš ï¸ ventas.db no encontrada. Ejecutando init_db.py..."
    docker run --rm -v "$PWD":/app -w /app --env-file .env python:3.9 python init_db.py
else
    docker run --rm -v "$PWD":/app -w /app --env-file .env python:3.9 python - <<EOF
import sqlite3, sys
db = sqlite3.connect("ventas.db")
c = db.cursor()
def check_table_column(table, column):
    c.execute(f"PRAGMA table_info({table})")
    return column in [r[1] for r in c.fetchall()]
try:
    c.execute("SELECT name FROM sqlite_master WHERE type='table' AND name='pedidos'")
    if not c.fetchone():
        raise Exception("Tabla pedidos no existe.")
    if not check_table_column("pedidos", "pdf_generado"):
        raise Exception("Columna pdf_generado no existe.")
    if not check_table_column("detalles_pedido", "tipo"):
        raise Exception("Columna tipo no existe.")
    if not check_table_column("usuarios", "password_hash"):
        raise Exception("Tabla usuarios incompleta.")
except Exception as e:
    print(f"âš ï¸ {e} Ejecutando init_db.py para corregir...")
    sys.exit(42)
EOF

    if [ $? -eq 42 ]; then
        docker run --rm -v "$PWD":/app -w /app --env-file .env python:3.9 python init_db.py
    else
        echo "âœ… Base de datos OK. Ejecutando migraciÃ³n..."
        docker run --rm -v "$PWD":/app -w /app --env-file .env python:3.9 python migrar_db.py || true
    fi
fi

# âœ… Compilar frontend con Node en contenedor (no requiere npm global)
echo "ğŸ§± Ejecutando build del frontend en contenedor..."
docker run --rm -v "$PWD/frontend":/app -w /app --env-file .env node:18-alpine sh -c "
  npm install && npm run build -- --mode production
"

# âœ… Desplegar contenedores
echo "ğŸš€ Reconstruyendo e iniciando contenedores..."
docker compose up --build -d

echo "âœ… Deploy completo. Contenedores corriendo en http://pedidosfriosur.com"
